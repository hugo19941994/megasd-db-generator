name: Generate XML

on: [push]

jobs:
    build:
        runs-on: ubuntu-latest

        strategy:
            matrix:
                python-version: [3.8]

        steps:
        - name: Checkout code
          uses: actions/checkout@v1

        - name: Setup Python
          uses: actions/setup-python@v1

        - name: Install pipenv
          uses: dschep/install-pipenv-action@v1

        - name: Install dependencies using Pipenv
          run: pipenv install --deploy --system

        - name: Download No-Intro and Redump dats
          run: python3 dat-downloader.py

        - name: Download game info DBs from IGDB
          run: python3 igdb-downloader.py
          env:
              IGDB_API_KEY: ${{ secrets.IGDB_API_KEY }}

        - name: Build db.xml
          run: python3 xml_builder.py

        - name: Store date into an environment variable
          run: echo "::set-env name=DATE::$(date '+%Y-%m-%d')"

        - name: Store release body into variable
          uses: pCYSl5EDgo/cat@master
          id: releaseText
          with:
              path: release.md

        - name: Create Github release
          id: create_release
          uses: actions/create-release@master
          env:
              GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          with:
              tag_name: ${{ github.ref }}
              release_name: DB ${{env.DATE}}
              body: ${{ steps.releaseText.outputs.text }}
              draft: true
              prerelease: true

        - name: Upload zipped database into the release
          id: upload-release-asset
          uses: actions/upload-release-asset@v1.0.1
          env:
              GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          with:
              upload_url: ${{ steps.create_release.outputs.upload_url }}
              asset_path: ./DB_${{env.DATE}}.zip
              asset_name: DB_${{env.DATE}}.zip
              asset_content_type: application/zip

